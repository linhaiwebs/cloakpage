<?php
declare(strict_types=1);

use App\Controllers\StockController;
use App\Controllers\TrackingController;
use App\Controllers\CustomerServiceController;
use App\Controllers\AdminController;
use Slim\App;
use Slim\Interfaces\RouteCollectorProxyInterface as Group;

return function (App $app) {
    // ÂÅ•Â∫∑Ê£ÄÊü•Á´ØÁÇπ
    $app->get('/health', function ($request, $response, $args) {
        $response->getBody()->write(json_encode(['status' => 'healthy', 'timestamp' => date('c')]));
        return $response->withHeader('Content-Type', 'application/json');
    });

    // ËÇ°Á•®Áõ∏ÂÖ≥API
    $app->group('/app/maike/api/stock', function (Group $group) {
        $group->get('/getinfo', StockController::class . ':getStockInfo');
    });

    // ËøΩË∏™Áõ∏ÂÖ≥API
    $app->group('/app/maike/api/info', function (Group $group) {
        $group->post('/page_track', TrackingController::class . ':pageTrack');
        $group->post('/uppage_track', TrackingController::class . ':upPageTrack');
        $group->post('/logError', TrackingController::class . ':logError');
    });

    // ÂÆ¢ÊúçÁõ∏ÂÖ≥API
    $app->group('/app/maike/api/customerservice', function (Group $group) {
        $group->post('/get_info', CustomerServiceController::class . ':getInfo');
        $group->post('/page_leave', CustomerServiceController::class . ':pageLeave');
        $group->post('/page_leaveurl', CustomerServiceController::class . ':pageLeaveUrl');
    });

    // ÁÆ°ÁêÜÂêéÂè∞È°µÈù¢
    $app->group('/admin', function (Group $group) {
        // ÁôªÂΩïÈ°µÈù¢ÂíåÁôªÂΩïÂ§ÑÁêÜÔºà‰∏çÈúÄË¶ÅËÆ§ËØÅÔºâ
        $group->get('', AdminController::class . ':login');
        $group->get('/', AdminController::class . ':login');
        $group->post('/login', AdminController::class . ':handleLogin');
        $group->get('/logout', AdminController::class . ':logout');
        
        // ÈúÄË¶ÅËÆ§ËØÅÁöÑÈ°µÈù¢
        $group->get('/dashboard', AdminController::class . ':dashboard');
        $group->get('/customer-services', AdminController::class . ':customerServices');
        $group->post('/customer-services', AdminController::class . ':customerServices');
        $group->get('/tracking', AdminController::class . ':trackingData');
        $group->get('/assignments', AdminController::class . ':assignments');
        
        // ÁÆ°ÁêÜÂêéÂè∞API
        $group->map(['GET', 'POST', 'PUT', 'DELETE'], '/api/customer-services', AdminController::class . ':apiCustomerServices');
        $group->get('/api/tracking', AdminController::class . ':apiTrackingData');
        $group->get('/api/assignments', AdminController::class . ':apiAssignments');
        $group->map(['GET', 'POST'], '/api/settings', AdminController::class . ':apiSettings');
    });

    // Ë∑≥ËΩ¨È°µÈù¢
    $app->get('/jpint', function ($request, $response, $args) {
        $html = '<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loading‚Ä¶</title>
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="color-scheme" content="light dark"/>

  <style>
    :root{
      --bg1:#10a35a; --bg2:#25D366;
      --surface:#ffffff; --surface-2:#f6faf8;
      --text-strong:#0b1f18; --text:#213a32; --muted:#5b6f66;
      --border:#e6f0ec; --border-strong:#d8e7e0;
      --accent:#1fbe61; --accent-2:#13a455; --accent-weak:#e8f7ee;
      --shadow: 0 14px 40px rgba(0,0,0,.12);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg1:#0b2a21; --bg2:#134332;
        --surface:#101a17; --surface-2:#0c1512;
        --text-strong:#eaf5ef; --text:#dff0e9; --muted:#b8d0c7;
        --border:#1c2f29; --border-strong:#27453b;
        --accent:#38d27a; --accent-2:#22c169; --accent-weak:#13261f;
        --shadow: 0 18px 50px rgba(0,0,0,.35);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:20px; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(900px 650px at 10% -10%, var(--bg2), transparent 60%),
        radial-gradient(900px 700px at 110% 120%, var(--bg1), transparent 55%),
        linear-gradient(120deg, var(--bg1), var(--bg2));
      color:var(--text-strong);
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, Segoe UI, Roboto, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    .card{
      width:min(680px, 92vw);
      background:var(--surface);
      border:1px solid var(--border-strong);
      border-radius:20px; box-shadow:var(--shadow);
      padding:26px 22px; display:flex; flex-direction:column; gap:16px; align-items:center; text-align:center;
    }

    .badge-row{display:flex; flex-wrap:wrap; gap:8px; justify-content:center}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-size:12px;
      background:var(--accent-weak); border:1px solid var(--border-strong); color:var(--text-strong)
    }
    .dot{width:8px; height:8px; border-radius:50%; background:#6ee7b7; box-shadow:0 0 10px #6ee7b7}

    .spinner{
      --s:64px; width:var(--s); height:var(--s); border-radius:50%;
      border:6px solid #e4efe9; border-top-color:var(--accent);
      animation:spin 1s linear infinite; position:relative; margin-top:4px;
    }
    .spinner:after{
      content:""; position:absolute; inset:-10px; border-radius:50%;
      border:1px dashed var(--border); animation:spin 6s linear infinite reverse;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (prefers-reduced-motion:reduce){.spinner,.spinner:after{animation:none}}

    .headline{ font-size:22px; line-height:1.35; letter-spacing:.2px; margin-top:6px; color:var(--text-strong); }
    .sub{ font-size:14.5px; line-height:1.8; color:var(--text); max-width:54ch }

    .progress{ width:100%; height:10px; border-radius:999px; background:var(--surface-2); border:1px solid var(--border); overflow:hidden }
    .bar{ width:0; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)) }

    .safe{ display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; }
    .shield{ width:18px; height:18px; border-radius:6px; display:grid; place-items:center; background:var(--surface-2); border:1px solid var(--border) }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:4px; }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:11px 16px; border-radius:12px; font-weight:700; font-size:14px;
      color:#062317; background:linear-gradient(180deg,var(--accent),var(--accent-2));
      box-shadow:0 8px 18px rgba(31,190,97,.25); border:1px solid rgba(0,0,0,.04);
      transition: transform .05s ease;
    }
    .btn:active{ transform: translateY(1px) }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter:saturate(.6) }

    .btn.secondary{
      background:var(--surface); color:var(--text-strong);
      border:1px solid var(--border-strong); box-shadow:none;
    }

    .foot{ color:var(--muted); font-size:12px; margin-top:2px; }
    .section{display:none}
    .section.active{display:block}
  </style>
</head>
<body>
  <main class="card" role="status" aria-live="polite" aria-busy="true">
    <div class="badge-row">
      <span class="badge"><span class="dot" aria-hidden="true"></span> <span id="badge-secure">Encrypted</span></span>
      <span class="badge" id="badge-no-spam">No spam</span>
      <span class="badge" id="badge-safe-bridge">Safe redirect</span>
    </div>

    <div class="spinner" aria-hidden="true"></div>
    <div id="headline" class="headline">Opening‚Ä¶</div>
    <div class="sub" id="cs-name" style="display:none;"></div>

    <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>

    <div class="safe">
      <div class="shield" aria-hidden="true">üõ°Ô∏è</div>
      <span id="safe-text">This is a secure bridge page. No personal data required.</span>
    </div>

    <!-- ‰∏ªÊìç‰ΩúÊåâÈíÆÔºöÊ†πÊçÆÊé•Âè£ËøîÂõûÂ°´ÂÖÖÂπ∂ÂêØÁî® -->
    <div class="actions">
      <button id="btn-open" class="btn" disabled aria-disabled="true">Open</button>
      <button id="btn-join" class="btn secondary" disabled aria-disabled="true">Join</button>
    </div>

    <!-- ÈîôËØØÊèêÁ§∫Âå∫Ôºà‰ªÖÂú®Êé•Âè£Â§±Ë¥•Êó∂Âá∫Áé∞Ôºâ -->
    <section id="sec-error" class="section" aria-live="assertive">
      <div class="headline" id="err-title" style="margin-top:8px;">Unable to connect</div>
      <div id="alertMessage" class="sub" style="margin-bottom:8px;">Please check your network or return to Home.</div>
      <div class="actions" style="margin-top:6px;">
        <button id="btn-home" class="btn">Back to Home</button>
        <button id="btn-retry" class="btn secondary">Retry</button>
      </div>
    </section>

    <div class="foot" id="foot-left">¬© Secure Bridge | Only launches the official app</div>
  </main>
<script>
(function () {
  // ===== Âü∫Êú¨ÈÖçÁΩÆÔºàÂèØË¢´ URL Ë¶ÜÁõñÔºâ=====
  const qp = new URLSearchParams(location.search);
  const serviceName = (window.SERVICE_NAME || qp.get(\'service\') || \'LINE\').trim();
  const lang = (qp.get(\'lang\') || \'ja\').toLowerCase();
  const originalRef = qp.get('original_ref') || ''; // Êñ∞Â¢ûÔºöËé∑ÂèñÂéüÂßã referrer

  const I18N = {
    \'en\': {
      badgeSecure: \'Encrypted connection\',
      badgeNoSpam: \'No spam or abuse\',
      badgeSafeBridge: \'Safe redirect\',
      opening: `Opening ${serviceName}‚Ä¶ Please wait`,
      csName: (name)=> name ? `Official account: ${name}` : \'\',
      safe: `This page is a secure bridge. No personal data is required.`,
      btnOpen: `Open ${serviceName} now`,
      btnJoin: \'Join now\',
      errTitle: \'Unable to connect\',
      errMsg: `Can\'t connect to ${serviceName}. Check your network or go back to the home page.`,
      home: \'Back to Home\', retry: \'Retry\',
      footLeft: \'¬© Secure Bridge | Only launches the official app\'
    },
    \'zh-tw\': {
      badgeSecure: \'ÈÄ£Á∑öÂ∑≤Âä†ÂØÜ\',
      badgeNoSpam: \'‰∏çÊúÉÁôºÈÄÅÂûÉÂúæË®äÊÅØ\',
      badgeSafeBridge: \'ÂÆâÂÖ®ËΩâÂùÄ\',
      opening: `Ê≠£Âú®ÈñãÂïü ${serviceName}ÔºåË´ãÁ®çÂÄô‚Ä¶`,
      csName: (name)=> name ? `ÂÆòÊñπÂ∏≥ËôüÔºö${name}` : \'\',
      safe: `Êú¨È†ÅÂÉÖ‰ΩúÁÇ∫‰∏≠ÁπºÊ©ãÊé•ÔºåÁÑ°ÈúÄÂ°´ÂØ´ÂÄã‰∫∫Ë≥áÊñô„ÄÇ`,
      btnOpen: `Á´ãÂç≥ÈñãÂïü ${serviceName}`,
      btnJoin: \'Á´ãÂç≥Âä†ÂÖ•\',
      errTitle: \'ÁÑ°Ê≥ïÈÄ£Á∑ö\',
      errMsg: `ÁÑ°Ê≥ïÈÄ£Á∑öËá≥ ${serviceName}„ÄÇË´ãÊ™¢Êü•Á∂≤Ë∑ØÊàñËøîÂõûÈ¶ñÈ†Å„ÄÇ`,
      home: \'ËøîÂõûÈ¶ñÈ†Å\', retry: \'ÈáçË©¶\',
      footLeft: \'¬© Secure BridgeÔΩúÂÉÖÂïüÂãïÂÆòÊñπÊáâÁî®\'
    },
    \'zh-cn\': {
      badgeSecure: \'ËøûÊé•Â∑≤Âä†ÂØÜ\',
      badgeNoSpam: \'‰∏ç‰ºöÂèëÈÄÅÂûÉÂúæ‰ø°ÊÅØ\',
      badgeSafeBridge: \'ÂÆâÂÖ®Ë∑≥ËΩ¨\',
      opening: `Ê≠£Âú®ÊâìÂºÄ ${serviceName}ÔºåËØ∑Á®çÂÄô‚Ä¶`,
      csName: (name)=> name ? `ÂÆòÊñπË¥¶Âè∑Ôºö${name}` : \'\',
      safe: `Ê≠§È°µÈù¢‰ªÖ‰Ωú‰∏≠ÁªßÊ°•Êé•ÔºåÊó†ÈúÄÂ°´ÂÜô‰∏™‰∫∫‰ø°ÊÅØ„ÄÇ`,
      btnOpen: `Á´ãÂç≥ÊâìÂºÄ ${serviceName}`,
      btnJoin: \'Á´ãÂç≥Âä†ÂÖ•\',
      errTitle: \'Êó†Ê≥ïËøûÊé•\',
      errMsg: `Êó†Ê≥ïËøûÊé•Âà∞ ${serviceName}„ÄÇËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñËøîÂõûÈ¶ñÈ°µ„ÄÇ`,
      home: \'ËøîÂõûÈ¶ñÈ°µ\', retry: \'ÈáçËØï\',
      footLeft: \'¬© Secure BridgeÔΩú‰ªÖÂêØÂä®ÂÆòÊñπÂ∫îÁî®\'
    },
    \'ja\': {
      badgeSecure: \'ÈÄö‰ø°„ÅØÊöóÂè∑Âåñ\',
      badgeNoSpam: \'Ëø∑ÊÉëË°åÁÇ∫„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì\',
      badgeSafeBridge: \'ÂÆâÂÖ®„Å™Ëª¢ÈÄÅ\',
      opening: `${serviceName} „ÇíÈñã„ÅÑ„Å¶„ÅÑ„Åæ„Åô‚Ä¶ „Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ`,
      csName: (name)=> name ? `ÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„ÉàÔºö${name}` : \'\',
      safe: \'„Åì„ÅÆ„Éö„Éº„Ç∏„ÅØ‰∏≠Á∂ôÂ∞ÇÁî®„Åß„Åô„ÄÇÂÄã‰∫∫ÊÉÖÂ†±„ÅÆÂÖ•Âäõ„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ\',
      btnOpen: `‰ªä„Åô„Åê ${serviceName} „ÇíÈñã„Åè`,
      btnJoin: \'‰ªä„Åô„ÅêÂèÇÂä†\',
      errTitle: \'Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü\',
      errMsg: `${serviceName} „Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Çí„ÅîÁ¢∫Ë™ç„ÅÑ„Åü„Å†„Åè„Åã„ÄÅ„Éõ„Éº„É†„Å´Êàª„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
      home: \'„Éõ„Éº„É†„Å´Êàª„Çã\', retry: \'ÂÜçË©¶Ë°å\',
      footLeft: \'¬© Secure Bridge | Ê≠£Ë¶è„Ç¢„Éó„É™„ÅÆ„Åø„ÇíËµ∑Âãï„Åó„Åæ„Åô\'
    }
  };
  const t = I18N[lang] || I18N.en;

  // ===== ÁªëÂÆö DOM =====
  const $ = (id)=> document.getElementById(id);
  const secError = $(\'sec-error\');
  const bar = $(\'bar\');
  const btnOpen = $(\'btn-open\');
  const btnJoin = $(\'btn-join\');

  // ÂàùÂßãÊñáÊ°à
  document.title = t.opening;
  $(\'badge-secure\').textContent = t.badgeSecure;
  $(\'badge-no-spam\').textContent = t.badgeNoSpam;
  $(\'badge-safe-bridge\').textContent = t.badgeSafeBridge;
  $(\'headline\').textContent = t.opening;
  $(\'safe-text\').textContent = t.safe;
  $(\'err-title\').textContent = t.errTitle;
  $(\'alertMessage\').textContent = t.errMsg;
  $(\'btn-home\').textContent = t.home;
  $(\'btn-retry\').textContent = t.retry;
  $(\'foot-left\').textContent = t.footLeft;
  btnOpen.textContent = t.btnOpen;
  btnJoin.textContent = t.btnJoin;

  // ===== ÈÖçÁΩÆÔºöÂçïÊ¨°ÊãâËµ∑ + ‰ªÖÂ§±Ë¥•Êó∂Ë∑≥ËΩ¨ =====
  const cfg = {
    openDelay: 150,       // È¶ñÊ¨°ÊãâËµ∑Âª∂Êó∂
    fallbackDelay: 5000,  // ÊàêÂäüÊ£ÄÊµãÁ™óÂè£ÔºàÊú™Á¶ªÂºÄÂàôËßÜ‰∏∫Â§±Ë¥•Ôºâ
  };

  // ===== ËΩªÈáèÊó•Âøó & ËøõÂ∫¶Êù° =====
  const isDebug = location.search.includes(\'debug=1\');
  function beacon(url, data){
    try{
      const blob = new Blob([JSON.stringify(data)], {type:\'application/json\'});
      if (!navigator.sendBeacon || !navigator.sendBeacon(url, blob)) {
        fetch(url, { method:\'POST\', headers:{\'Content-Type\':\'application/json\'}, body: JSON.stringify(data), keepalive:true }).catch(()=>{});
      }
    }catch(_){}
  }
  function logError(message, extra={}){
    if (isDebug) console.warn(\'[LOG]\', message, extra);
    beacon(\'/app/maike/api/info/logError\', {
      message, stack: extra.stack||\'\', url:location.href, referrer:document.referrer,
      lang, serviceName, recordId, serviceUrl, fallbackUrl:fallbackLink
    });
  }
  function startProgress(){
    if (!bar) return;
    let p = 0; bar.style.width = \'0%\';
    const step = ()=> {
      if (!bar || p >= 95) return;
      p += Math.random()*18 + 8; if (p>95) p = 95;
      bar.style.width = p + \'%\';
      requestAnimationFrame(()=> setTimeout(step, 260));
    };
    step();
  }

  // ===== Áä∂ÊÄÅ =====
  let recordId = \'\', serviceUrl = \'\', fallbackLink = \'/\', csDisplayName = \'\';
  const guards = { fallbackTimer: null, launchSuccess: false, openedAt: 0, listenersOn: false };

  // Â§öÁ≠ñÁï•ÊâìÂºÄÔºà‰∏çÂå∫ÂàÜ iOS/AndroidÔºâ
  function openWithStrategies(url) {
    try { window.location.href = url; } catch(_){}
    try { window.location.assign(url); } catch(_){}
    try { window.location.replace(url); } catch(_){}
    try {
      const ifr = document.createElement(\'iframe\');
      ifr.style.display = \'none\';
      ifr.src = url;
      document.body.appendChild(ifr);
      setTimeout(() => { try { document.body.removeChild(ifr); } catch(_){} }, 1800);
    } catch(_){}
    try {
      const a = document.createElement(\'a\');
      a.href = url;
      a.style.display = \'none\';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } catch(_){}
  }

  // ===== ÊàêÂäüÁõëÊµã & ÂÖúÂ∫ïË∑≥ËΩ¨ÊéßÂà∂ =====
  function removeSuccessListeners(){
    if (!guards.listenersOn) return;
    document.removeEventListener(\'visibilitychange\', onVis);
    window.removeEventListener(\'pagehide\', onPageHide);
    window.removeEventListener(\'blur\', onBlurEarly);
    guards.listenersOn = false;
  }
  function markLaunchedSuccess(){
    if (guards.launchSuccess) return;
    guards.launchSuccess = true;
    clearTimeout(guards.fallbackTimer);
    removeSuccessListeners();
    beacon(location.origin + \'/app/maike/api/customerservice/page_leave\', { id: recordId, success:true });
    if (isDebug) console.log(\'[launch] success detected, no fallback redirect\');
  }
  function onVis(){
    if (document.visibilityState === \'hidden\') markLaunchedSuccess();
  }
  function onPageHide(){
    markLaunchedSuccess();
  }
  function onBlurEarly(){
    // Êüê‰∫õ iOS/Android Âú∫ÊôØÂÖàËß¶Âèë blurÔºåÂÜçÈöêËóèÔºõÈôêÂÆöÊó©ÊúüÁ™óÂè£ÂÜÖÊúâÊïà
    if (performance.now() - guards.openedAt < 1200) markLaunchedSuccess();
  }

  function launchOnce(){
    guards.launchSuccess = false;
    guards.openedAt = performance.now();

    // ÁªëÂÆö‰∏ÄÊ¨°ÊÄßÁöÑÊàêÂäüÁõëÊµãÁõëÂê¨
    if (!guards.listenersOn){
      document.addEventListener(\'visibilitychange\', onVis);
      window.addEventListener(\'pagehide\', onPageHide);
      window.addEventListener(\'blur\', onBlurEarly);
      guards.listenersOn = true;
    }

    // ÂÆâÊéíÂÖúÂ∫ïÔºö‰ªÖÂΩìÊú™ÊàêÂäüÊó∂ÊâçË∑≥ Links
    clearTimeout(guards.fallbackTimer);
    guards.fallbackTimer = setTimeout(()=>{
      if (!guards.launchSuccess) {
        logError(\'fallback: open failed ‚Üí redirect to Links\');
        beacon(location.origin + \'/app/maike/api/customerservice/page_leaveurl\', { id: recordId, url: fallbackLink });
        location.href = fallbackLink;
      }
    }, cfg.fallbackDelay);

    // Á®çÁ≠âÂÜçÊãâËµ∑ÔºåÁªôÊµèËßàÂô®Êó∂Èó¥Ê∏≤Êüì
    setTimeout(()=> openWithStrategies(serviceUrl), cfg.openDelay);
  }

  // ===== ÊãâÂèñÁõÆÊ†áÂπ∂ÂêØÂä®ÊµÅÁ®ãÔºàÂè™Â∞ùËØï‰∏ÄÊ¨°Ëá™Âä®ÊãâËµ∑Ôºâ=====
  async function fetchServiceData(){
    secError.classList.remove(\'active\');
    startProgress();
    try{
      const res = await fetch(location.origin + \'/app/maike/api/customerservice/get_info\', {
        method:\'POST\',
        headers:{
          \'Content-Type\':\'application/json\',
          \'timezone\': Intl.DateTimeFormat().resolvedOptions().timeZone,
          \'language\': lang
        },
        body: JSON.stringify({
          stockcode: localStorage.getItem(\'stockcode\') || \'\',
          text: localStorage.getItem('text') || '',
          original_ref: decodeURIComponent(originalRef) // Êñ∞Â¢ûÔºöÂèëÈÄÅÂéüÂßã referrer
        })
      });
      const data = await res.json();
      if (isDebug) console.log(\'[get_info]\', data);

      if (data.statusCode === \'ok\' && data.CustomerServiceUrl){
        recordId = data.id;
        serviceUrl = data.CustomerServiceUrl;
        fallbackLink = data.Links || \'/\';
        csDisplayName = data.CustomerServiceName || \'\';

        // Â±ïÁ§∫ÂÆ¢ÊúçÂêçÔºàÂ¶ÇÊúâÔºâ
        const nameEl = $(\'cs-name\');
        const nameTxt = (t.csName && typeof t.csName === \'function\') ? t.csName(csDisplayName) : \'\';
        if (nameTxt) { nameEl.textContent = nameTxt; nameEl.style.display = \'\'; }

        // ÂêØÁî®ÊåâÈíÆÔºàÂ§öËØ≠Ë®ÄÊñáÊ°àÔºâ
        btnOpen.disabled = false; btnOpen.setAttribute(\'aria-disabled\',\'false\'); btnOpen.textContent = t.btnOpen;
        btnJoin.disabled = false; btnJoin.setAttribute(\'aria-disabled\',\'false\'); btnJoin.textContent = t.btnJoin;

        // ÁªëÂÆöÊåâÈíÆÊìç‰Ωú
        btnOpen.onclick = ()=> {
          beacon(location.origin + \'/app/maike/api/customerservice/page_leave\', { id: recordId, action:\'open\' });
          launchOnce(); // ÊâãÂä®‰πüËµ∞ÊàêÂäüÁõëÊµã + Â§±Ë¥•Ë∑≥ËΩ¨
        };
        btnJoin.onclick = ()=> {
          beacon(location.origin + \'/app/maike/api/customerservice/page_leaveurl\', { id: recordId, url: fallbackLink, action:\'join\' });
          location.href = fallbackLink;
        };

        // ËøõÂ∫¶Êù°ÊãâÊª°
        if (bar) bar.style.width=\'100%\';

        // Ëá™Âä®ÊãâËµ∑Ôºà‰ªÖ‰∏ÄÊ¨°Ôºâ
        launchOnce();

      } else {
        throw new Error(\'URL not provided\');
      }
    }catch(err){
      logError(\'fetchServiceData error: \' + (err.message||\'unknown\'), err);
      secError.classList.add(\'active\');
    }
  }

  // ÈîôËØØÂå∫‰∫§‰∫í
  $(\'btn-retry\')?.addEventListener(\'click\', fetchServiceData);
  $(\'btn-home\')?.addEventListener(\'click\', ()=>{ logError(\'user: back home\'); location.href=\'/\' });

  // ===== ÂêØÂä® =====
  fetchServiceData();
})();
</script>

</body>
</html>';
        $response->getBody()->write($html);
        return $response->withHeader('Content-Type', 'text/html; charset=utf-8');
    });
};